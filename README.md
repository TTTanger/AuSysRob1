# 乐高积木识别和抓取系统

这是一个基于Tinkerbot Braccio五轴机械臂和Logitech C270摄像头的乐高积木识别和抓取系统。

## 系统功能

- 🤖 **机械臂控制**: 基于DH参数的正向运动学控制
- 🔍 **视觉识别**: 使用OpenCV识别红色乐高积木
- 📐 **手眼标定**: 自动校准摄像头像素坐标和物理坐标
- 🧮 **逆运动学**: 计算机械臂关节角度
- 🔧 **误差补偿**: 可调节的机械误差补偿参数
- 🔄 **自动抓取**: 循环检测和抓取功能

## 系统架构

```
LegoGraspingSystem.py (主程序)
├── HandEyeCalibration.py (手眼标定)
├── ForwardController.py (正向控制)
├── InverseKinematic.py (逆运动学)
└── RobotCompensation.py (误差补偿)
```

## 安装要求

### 硬件要求
- Tinkerbot Braccio 五轴机械臂
- Logitech C270 摄像头
- 红色乐高积木块
- USB串口连接线

### 软件要求
- Python 3.7+
- Windows 10/11 (或其他支持OpenCV的系统)

## 安装步骤

1. **克隆或下载项目文件**
   ```bash
   # 确保所有Python文件在同一目录下
   ```

2. **安装Python依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **检查硬件连接**
   - 确保机械臂通过USB串口连接到电脑
   - 确保摄像头正确连接
   - 检查串口号（Windows默认为COM5）

## 配置说明

### 1. 串口配置
在 `RobotCompensation.py` 中修改串口参数：
```python
SERIAL_PORT = 'COM5'  # 根据实际情况修改
BAUD_RATE = 115200
TIMEOUT = 5
```

### 2. 摄像头配置
```python
CAMERA_INDEX = 0  # 摄像头索引，通常为0
```

### 3. 机械误差补偿
在 `RobotCompensation.py` 中调整补偿参数：
```python
# 关节角度补偿
BASE_OFFSET = 0.0      # 基座补偿
SHOULDER_OFFSET = 0.0  # 肩部补偿
ELBOW_OFFSET = 0.0     # 肘部补偿
WRIST_OFFSET = 0.0     # 腕部补偿
TWIST_OFFSET = 0.0     # 扭转补偿

# 位置补偿
X_POSITION_OFFSET = 0.0  # X方向补偿
Y_POSITION_OFFSET = 0.0  # Y方向补偿
Z_POSITION_OFFSET = 0.0  # Z方向补偿
```

## 使用步骤

### 1. 启动系统
```bash
python LegoGraspingSystem.py
```

### 2. 手眼标定
1. 将红色乐高积木放置在摄像头视野内
2. 按 'c' 确认拍摄
3. 测量积木相对于机械臂基座中心点的物理坐标
4. 输入X和Y坐标（毫米）

### 3. 自动抓取
- 按 'g' 执行抓取
- 按 'r' 重新标定
- 按 'q' 退出程序

## 系统工作流程

```
1. 系统初始化
   ├── 连接机械臂
   ├── 打开摄像头
   └── 检查硬件状态

2. 手眼标定
   ├── 拍摄标定图像
   ├── 识别红色积木
   ├── 输入物理坐标
   └── 计算补偿向量

3. 检测和抓取循环
   ├── 实时检测红色积木
   ├── 计算抓取位置
   ├── 检查可达性
   ├── 执行抓取序列
   └── 返回安全位置
```

## 抓取序列

1. **移动到安全高度**: 避免碰撞
2. **移动到抓取位置**: 精确到达目标位置
3. **闭合夹持器**: 抓取积木
4. **移动到安全高度**: 完成抓取

## 故障排除

### 常见问题

1. **摄像头无法打开**
   - 检查摄像头连接
   - 确认摄像头索引正确
   - 检查其他程序是否占用摄像头

2. **机械臂连接失败**
   - 检查串口号是否正确
   - 确认串口线连接正常
   - 检查机械臂电源

3. **无法识别红色积木**
   - 调整光照条件
   - 修改HSV阈值参数
   - 确保积木颜色为红色

4. **机械臂位置不准确**
   - 调整补偿参数
   - 重新进行手眼标定
   - 检查机械臂机械误差

### 调试模式

启用调试模式查看详细信息：
```python
DEBUG_MODE = True
```

## 参数调整

### 红色检测阈值
在 `RobotCompensation.py` 中调整：
```python
RED_DETECTION_THRESHOLD = {
    'lower_red1': [0, 100, 100],
    'upper_red1': [10, 255, 255],
    'lower_red2': [160, 100, 100],
    'upper_red2': [180, 255, 255],
    'min_area': 1000
}
```

### 抓取参数
```python
GRIP_HEIGHT = 50.0        # 抓取高度
GRIPPER_OPEN_ANGLE = 180  # 夹持器打开角度
GRIPPER_CLOSE_ANGLE = 0   # 夹持器闭合角度
SAFE_HEIGHT = 100.0       # 安全高度
```

## 安全注意事项

1. **机械臂安全**
   - 确保工作区域无障碍物
   - 保持安全距离
   - 紧急情况下立即关闭电源

2. **摄像头安全**
   - 避免直视摄像头
   - 保护摄像头镜头

3. **系统安全**
   - 定期检查机械臂状态
   - 备份重要参数
   - 测试前进行安全检查

## 技术支持

如遇到问题，请检查：
1. 硬件连接状态
2. 软件依赖版本
3. 参数配置正确性
4. 系统日志信息

## 版本信息

- 版本: 1.0.0
- 更新日期: 2024年
- 支持平台: Windows/Linux
- Python版本: 3.7+ 